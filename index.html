<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>upload</title>
</head>
<body>
  <h1>名前で保存する</h1>
<pre>
  <code>
    Private Sub key_end_Click()

    Dim list_cou As Long, list_ro() As Long, tf() As String, man As String
Dim ws As Worksheet, d_main As Workbook, pat As String
Dim myRange As Range, myObj1 As Range, myCell As Range, e_row As Long, bun_k As Variant
Dim myRange_val As Range, myObj1_val As Range, bun_k1 As Variant
Dim new_ma As Variant

Const pass_row = 2
Const pass_col = "J"
Const titleRow = 1

With Application
    .Calculation = xlCalculationManual
    .ScreenUpdating = False
End With

Set ws = ThisWorkbook.Sheets(main_sh)


If Not (Me.TextBox12.Text = "") And TextBox18.Text <> "" And Me.ListBox1.ListIndex <> -1 And Me.ListBox2.ListIndex <> -1 And Me.ListBox3.ListIndex <> -1 Then ''''''''①保存が必要の場合の処理

                man = Replace(Me.TextBox12.Text, vbCrLf, "")
                man = Replace(man, " ", "")
                man = Replace(man, "　", "") ''''''''名前を変数に入れる


        ew_text = Me.TextBox18.Text ''''''''自分の説明を変数に入れる
        
        shName = Me.ListBox1.List(Me.ListBox1.ListIndex, 0) ''''''''シート名を変数に入れる
    coumokuLarge = Me.ListBox2.List(Me.ListBox2.ListIndex, 0) ''''''''大項目を変数に入れる
    coumokuMidle = Me.ListBox2.List(Me.ListBox2.ListIndex, 0) '''''''中告目を変数に入れる
        
        If Dir(pat) <> "" Then
                Application.ScreenUpdating = False
                f_cou = 0
                    If Isbookopen(fname) = False Then
rep:
                       Set d_main = Workbooks.Open(Filename:=pat, ReadOnly:=False, IgnoreReadOnlyRecommended:=True)
                       With d_main
                            If .ReadOnly Then
                                .Close False
                                    f_cou = f_cou + 1
                                     If f_cou >= 4 Then
                                        With Application
                                            .Calculation = xlCalculationAutomatic
                                            .ScreenUpdating = True
                                        End With
                                            MsgBox "再度、時間を置いて保存作業を実施して下さい。", vbExclamation, "保存作業中断"
                                        Exit Sub
                                     Else
                                        GoTo rep
                                     End If
                            Else

                            '''''''保存の処理

                            


                            Set myRange = d_main.Sheets(shName).Rows(titleRow)
                            Set myObj1 = myRange.Find(man, LookAt:=xlWhole)
                            
                            If Err.Number = 0 Then ''''''''シートの存在を確認
                            
                            
                                If myObj1 Is Nothing Then
                                    '''''新規ユーザーの追加処理
                                    e_column = d_main.Sheets(que_sh).UsedRange.Columns(d_main.Sheets(que_sh).UsedRange.Columns.Count).Column + 1
                                    With d_main.Sheets(shName)
                                        .Cells(titleRow, e_row).Value = man
                                    
                                    
                                        Set myRangeLerge = d_main.Sheets(shName).Columns(2)
                                        Set myObjLerge = myRangeLerge.Find(coumokuLarge, LookAt:=xlWhole)
                                            If myObjLerge Is Nothing Then
                                                d_main.Close savechanges:=False
                                                MsgBox shName & "大項目が参照できませんでした。", vbCritical, "大項目参照エラー"
                                                Exit Sub
                                            Else
                                                If .Cells(myObjLerge.Row, 4).Value = coumokuMidle Then
                                                    .Cells(myObjLerge.Row, e_column).Value = ew_text
                                                    d_main.Close savechanges:=True
                                                    With Application
                                                        .Calculation = xlCalculationAutomatic
                                                        .ScreenUpdating = True
                                                    End With
                                                    MsgBox man & "さんの実施情報を新規で登録しました。", vbInformation, "データ保存完了"
                                                Else
                                                '''''''次を検索
                                                    
                                                    Set myCellLerge = myObjLerge
                                                    i = 0
                                                    Do
                                                    
                                                        If .Cells(myCellLerge.Row, 4).Value = coumokuMidle Then
                                                            .Cells(myObjLerge.Row, e_column).Value = ew_text
                                                            d_main.Close savechanges:=True
                                                            With Application
                                                                .Calculation = xlCalculationAutomatic
                                                                .ScreenUpdating = True
                                                            End With
                                                                MsgBox man & "さんの実施情報を新規で登録しました。", vbInformation, "データ保存完了"
                                                        
                                                            Exit Sub
                                                        End If
                                                    Set myCellLerge = myRangeLerge.FindNext(myCellLerge)
                                                    Loop While myCellLerge.Row <> myObjLerge.Row
                                                
                                                
                                                
                                                    d_main.Close savechanges:=False
                                                    With Application
                                                        .Calculation = xlCalculationAutomatic
                                                        .ScreenUpdating = True
                                                    End With
            
                                                    MsgBox man & "中古項目の参照ができませんでした。", vbCritical, "中項目参照エラー"
                                                
                                                End If
                                            
                                            
                                            

                                            End If
                                    
                                    
                                    
                                    
                                    
                                    
                                    
                              

                                        d_main.Close savechanges:=True
                                        With Application
                                            .Calculation = xlCalculationAutomatic
                                            .ScreenUpdating = True
                                        End With

                                        MsgBox man & "さんの実施情報を新規で登録しました。", vbInformation, "データ保存完了"
                                    Exit Sub
                                    
                                    
                                    End With
                                    
                                Else
                                    
                                                e_column = myObj1.Column
                                    With d_main.Sheets(shName)
                                        .Cells(titleRow, e_row).Value = man
                                    
                                    
                                        Set myRangeLerge = d_main.Sheets(shName).Columns(2)
                                        Set myObjLerge = myRangeLerge.Find(coumokuLarge, LookAt:=xlWhole)
                                            If myObjLerge Is Nothing Then
                                                d_main.Close savechanges:=False
                                                MsgBox shName & "大項目が参照できませんでした。", vbCritical, "大項目参照エラー"
                                                Exit Sub
                                            Else
                                                If .Cells(myObjLerge.Row, 4).Value = coumokuMidle Then
                                                    .Cells(myObjLerge.Row, e_column).Value = ew_text
                                                    d_main.Close savechanges:=True
                                                    With Application
                                                        .Calculation = xlCalculationAutomatic
                                                        .ScreenUpdating = True
                                                    End With
                                                    MsgBox man & "さんの実施情報を新規で登録しました。", vbInformation, "データ保存完了"
                                                Else
                                                '''''''次を検索
                                                    
                                                    Set myCellLerge = myObjLerge
                                                    i = 0
                                                    Do
                                                    
                                                        If .Cells(myCellLerge.Row, 4).Value = coumokuMidle Then
                                                            .Cells(myObjLerge.Row, e_column).Value = ew_text
                                                            d_main.Close savechanges:=True
                                                            With Application
                                                                .Calculation = xlCalculationAutomatic
                                                                .ScreenUpdating = True
                                                            End With
                                                                MsgBox man & "さんの実施情報を新規で登録しました。", vbInformation, "データ保存完了"
                                                        
                                                            Exit Sub
                                                        End If
                                                    Set myCellLerge = myRangeLerge.FindNext(myCellLerge)
                                                    Loop While myCellLerge.Row <> myObjLerge.Row
                                                
                                                
                                                
                                                    d_main.Close savechanges:=False
                                                    With Application
                                                        .Calculation = xlCalculationAutomatic
                                                        .ScreenUpdating = True
                                                    End With
            
                                                    MsgBox man & "中古項目の参照ができませんでした。", vbCritical, "中項目参照エラー"
                                                
                                                End If
                                            
                                            
                                            

                                            End If
                                    
                                    
                                    
                                    
                                    
                                    
                                    
                              

                                        d_main.Close savechanges:=True
                                        With Application
                                            .Calculation = xlCalculationAutomatic
                                            .ScreenUpdating = True
                                        End With

                                        MsgBox man & "さんの実施情報を新規で登録しました。", vbInformation, "データ保存完了"
                                    Exit Sub
                                    
                                    
                                    End With
                                    
                                    
                                    
                                End If
                                
                                
                                
                                
                                
                                
                                
                                
                            Else
                                d_main.Close savechanges:=False
                                MsgBox shName & "シートが参照できませんでした。", vbCritical, "DBシート参照エラー"
                                Exit Sub
                            End If
            End If
        Else
            MsgBox "DBファイルがありません。", vbCritical, "DBファイル参照エラー"
        End If
        
        
        
        
        
End If
    
    With Application
        .Calculation = xlCalculationAutomatic
        .ScreenUpdating = True
    End With
    
    End Sub
  </code>
</pre>
  
</body>
</html>