<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>upload</title>
</head>
<body>
  <h1>名前で保存する</h1>
  <p>d6 リソースシートb3 完了以外を表示</p>
 
<pre>
  <code>

No	内訳	区分	区分番号	案件年月度	プロジェクト内容	じょうたい	状態	計画開始日	計画開始時間	計画終了日	計画終了時間	計画内訳	実績内訳	備考欄
1	計画	お客様に迷惑	2	2024/1/1	とりあえず資料を完成させる	未完	着手中	2024/2/6	13:00	2024/2/16	15:00	要件定義-山下-4/設計-山下-3/製造-飯田-2/リリース-飯田-１	2024/2/1-21:52:00&2024/2/3-21:52:00,2024/2/4-21:52:00&2024/2/6-21:52:00,2024/2/7-21:52:00&2024/2/9-21:52:00,	ここは平行して何人どんな作業がある
2	差し込み	法令遵守	1	2024/3/1	テスト2	完了	終了							
3	差し込み	テスト	3	2023/12/1	テスト3	未完	未着手	　　						今年中に開発をおねがいしたい
4	計画	お客様に迷惑	2	2024/2/1	追加の編集	未完	着手中	2024/2/16	10:30	2024/2/26	16:00	要件定義-岩本-4/設計-岩本-3/製造-山下-2/リリース-進-１	2024/2/15-09:52:00&2024/2/19-17:52:00,2024/2/20-09:52:00&,	進捗確認2/20に実施します

    


    
    Const shname_kaihatu = "開発カレンダー"
Sub main()
Const all_f = "開発スケジュール"
Const all_s = "リソースシート"
Const ro = 6
Const co = 4
Const shm = "MAIN"
Const shs = "計画表原紙"
Const key_path = "C:\Users\yama7\Desktop\ジャパネット\データベース.xlsx"
Const sh_name1 = "情報"
Const num_cul = 1
Const manth_cul = 2
Const status_cul = 3
Const status_cul_num = 4
Const status2_cul = 5
Const yotei_st_cul = 6
Const yotei_en_cul = 7
Const jiss_st_cul = 8
Const jiss_en_cul = 9
Const naiyou_cul = 10

Const insertRow = 10
Const insertNum = 1



Dim sh As Worksheet, sh_name As Variant, wb As Workbook
Dim WB_p As Workbook
Dim num() As Long
Dim utiwake() As String, kubunn() As String, kubunn_num() As Long, annkennnenngetu() As Date, naiyou() As String, jyoutai_1() As String, jyoutai_2() As String
Dim keikakuhi() As Date, keikakujikan() As Date, syuuryouhi() As Date, syuurokujikan() As Date
Dim keikakukutiwake() As String, syuuryouutiwake() As String, gaiyou() As String, endRow As Long
Dim i As Long, p As Long, j As Long, writeRow As Long
Dim column_num As Long, row_num As Long, jisseki As Variant, jisseki1 As Variant, jisseki2 As Variant, jissekibi As Date
Dim jisseki_v As Variant

With Application
    .Calculation = xlCalculationManual
    .ScreenUpdating = False
End With



On Error Resume Next
Set wb = ThisWorkbook
Set sh = wb.Sheets(ActiveSheet.Name)
With sh

    If .Cells(ro, co).Value = "" Then
        Exit Sub
    End If
'----------------------必要なシート以外を削除しましょう
    For Each sh_name In Worksheets            'シートすべてに実行する
        If sh_name.Name <> shm And sh_name.Name <> shs Then
            Application.DisplayAlerts = False
                With wb
                    .Sheets(sh_name.Name).Delete
                End With
            Application.DisplayAlerts = True
        End If
    Next
            wb.Sheets(shs).Visible = True
    wb.Sheets(shs).Copy after:=wb.Sheets(shm)
    ActiveSheet.Name = shname_kaihatu
            wb.Sheets(shs).Visible = False


'----------------------情報の原紙をコピーしてくる
Set WB_p = Workbooks.Open(Filename:=key_path, ReadOnly:=True, UpdateLinks:=False)
        
            WB_p.Sheets(sh_name1).Copy before:=wb.Sheets(1)
            
            wb.Sheets(sh_name1).Visible = False
            WB_p.Close savechanges:=False
                If Err.Number <> 0 Then
                    End
                End If

    ''''''''''並び替えをおこなう
    With wb.Sheets(sh_name1)
        column_num = .Cells(1, Columns.Count).End(xlToLeft).Column
        row_num = .Cells(Rows.Count, 1).End(xlUp).Row
        
        .Range(.Cells(2, 1), .Cells(row_num, column_num)).Sort Key1:=.Cells(1, status2_cul), Order1:=xlAscending, Key2:=.Cells(1, status_cul_num), Order2:=xlAscending, Header:=xlNo
    End With
    


    If .Cells(ro, co).Value = all_f Then
        MsgBox all_f
        
        
        
        
    ElseIf .Cells(ro, co).Value = all_s Then
        ''''まずはここから作成していってますよ
With wb.Sheets(sh_name1)
    endRow = .Cells(Rows.Count, 1).End(xlUp).Row
    ReDim num(endRow)
    ReDim utiwake(endRow) As String, kubunn(endRow) As String, kubunn_num(endRow) As Long, annkennnenngetu(endRow) As Date, naiyou(endRow) As String, jyoutai_1(endRow) As String, jyoutai_2(endRow) As String
    ReDim keikakuhi(endRow) As Date, keikakujikan(endRow) As Date, syuuryouhi(endRow) As Date, syuurokujikan(endRow) As Date
    ReDim keikakukutiwake(endRow) As String, syuuryouutiwake(endRow) As String, gaiyou(endRow) As String
 

    If endRow = 1 Then
        End
    End If
    i = 2
    p = 1
                            Do While .Cells(i, num_cul).Value <> ""
                                If sh.Cells(3, 2).Value = "完了以外を表示" Then
                                    If .Cells(i, yotei_en_cul).Value <> "完了" And .Cells(i, yotei_en_cul).Value <> "終了" Or .Cells(i, status2_cul).Value >= Format(Now, "yyyy/mm/01") Then
                                        num(p) = .Cells(i, num_cul).Value
                                        utiwake(p) = .Cells(i, manth_cul).Value
                                        kubunn(p) = .Cells(i, status_cul).Value
                                        kubunn_num(p) = .Cells(i, status_cul_num).Value
                                        annkennnenngetu(p) = .Cells(i, status2_cul).Value
                                        naiyou(p) = .Cells(i, yotei_st_cul).Value
                                        jyoutai_1(p) = .Cells(i, yotei_en_cul).Value
                                        jyoutai_2(p) = .Cells(i, jiss_st_cul).Value
                                        keikakuhi(p) = .Cells(i, jiss_en_cul).Value
                                        keikakujikan(p) = .Cells(i, naiyou_cul).Value
                                        syuuryouhi(p) = .Cells(i, naiyou_cul + 1).Value
                                        syuurokujikan(p) = .Cells(i, naiyou_cul + 2).Value
                                        keikakukutiwake(p) = .Cells(i, naiyou_cul + 3).Value
                                        syuuryouutiwake(p) = .Cells(i, naiyou_cul + 4).Value
                                        gaiyou(p) = .Cells(i, naiyou_cul + 5).Value
                                    End If
                                Else
                                    num(p) = .Cells(i, num_cul).Value
                                    utiwake(p) = .Cells(i, manth_cul).Value
                                    kubunn(p) = .Cells(i, status_cul).Value
                                    kubunn_num(p) = .Cells(i, status_cul_num).Value
                                    annkennnenngetu(p) = .Cells(i, status2_cul).Value
                                    naiyou(p) = .Cells(i, yotei_st_cul).Value
                                    jyoutai_1(p) = .Cells(i, yotei_en_cul).Value
                                    jyoutai_2(p) = .Cells(i, jiss_st_cul).Value
                                    keikakuhi(p) = .Cells(i, jiss_en_cul).Value
                                    keikakujikan(p) = .Cells(i, naiyou_cul).Value
                                    syuuryouhi(p) = .Cells(i, naiyou_cul + 1).Value
                                    syuurokujikan(p) = .Cells(i, naiyou_cul + 2).Value
                                    keikakukutiwake(p) = .Cells(i, naiyou_cul + 3).Value
                                    syuuryouutiwake(p) = .Cells(i, naiyou_cul + 4).Value
                                    gaiyou(p) = .Cells(i, naiyou_cul + 5).Value
                                End If
                                p = p + 1
                                i = i + 1
                            Loop

                                With ThisWorkbook.Sheets(shname_kaihatu)
                                For j = 1 To p - 1
                                    
                                
                                        If annkennnenngetu(j) <> "0:00:00" Then
                                            Range(.Rows(insertRow), .Rows(insertRow + insertNum)).Copy
                                            writeRow = .Cells(Rows.Count, "P").End(xlUp).Row + 1
                                            Range(.Rows(writeRow), .Rows(writeRow + insertNum)).Insert
                                            Application.CutCopyMode = False
                                        
                                        
                                            .Cells(writeRow, "B").Value = num(j)
                                            .Cells(writeRow, "C").Value = utiwake(j)
                                            .Cells(writeRow, "D").Value = kubunn(j)
                                            .Cells(writeRow, "Q").Value = annkennnenngetu(j)
                                            .Cells(writeRow, "E").Value = naiyou(j)
                                            
                                            .Cells(writeRow, "R").Value = jyoutai_1(j)
                                            .Cells(writeRow, "S").Value = jyoutai_2(j)
                                            If keikakuhi(j) <> "0:00:00" Then
                                                .Cells(writeRow, "J").Value = keikakuhi(j) & " " & keikakujikan(j)
                                                .Cells(writeRow, "K").Value = syuuryouhi(j) & " " & syuurokujikan(j)
                                                .Cells(writeRow, "V").Value = keikakuhi(j)
                                                .Cells(writeRow, "W").Value = syuuryouhi(j)
                                                
                                                
                                                StartDate = .Cells(writeRow, "J").Value
                                                EndDate = .Cells(writeRow, "K").Value
                                                If StartDate <= Now Then
                                                    .Cells(writeRow, "L").Value = (DateDiff("s", StartDate, Now) / DateDiff("s", StartDate, EndDate)) * 100
                                                    If .Cells(writeRow, "L").Value > 100 Then
                                                        .Cells(writeRow, "L").Font.ColorIndex = 3
                                                    End If
                                                End If
                                                .Cells(writeRow, "M").Value = DateDiff("h", Now, EndDate)
                                                    
                                                
                                                
                                            End If
                                            .Cells(writeRow, "T").Value = keikakukutiwake(j)
                                            .Cells(writeRow, "U").Value = syuuryouutiwake(j)
                                            .Cells(writeRow, "Z").Value = kubunn_num(j)
                                            If gaiyou(j) <> "" Then
                                                With .Cells(writeRow, "E").AddComment
                                                    .Text Text:=gaiyou(j)
                                                    .Visible = False
                                                End With
                                            End If
                                            
                                            If .Cells(writeRow, "U").Value <> "" Then
                                                jisseki = Split(.Cells(writeRow, "U").Value, ",")
                                                'jisseki_v = jisseki(0)
                                                
                                                jisseki1 = Split(jisseki(0), "&")
                                                'jisseki_v = jisseki1
                                                jisseki2 = Split(jisseki1(0), "-")
                                                
                                                jissekibi = jisseki2(0)
                                                
                                                .Cells(writeRow, "X").Value = jissekibi
                                                .Cells(writeRow, "N").Value = jissekibi
                                                    aa = Split(.Cells(writeRow, "T").Value, "/")
                                                    aaa = UBound(aa)
                                                    bb = Split(.Cells(writeRow, "U").Value, ",")
                                                    bbb = Split(bb(aaa), "&")
                                                    cc = Split(bbb(0), "-")
                                                    If Err.Number = 0 Then
                                                        .Cells(writeRow, "O").Value = jisseki2(1)
                                                        .Cells(writeRow, "Y").Value = jisseki2(1)
                                                        
                                                        
                                                        '''背景色をへんこうする
                                                        .Range(.Cells(writeRow, "B"), .Cells(writeRow, "O")).Interior.ColorIndex = 15
                                                        .Cells(writeRow, "L").Value = ""
                                                        .Cells(writeRow, "M").Value = ""
                                                    End If
                                                
                                            End If
                                           
                                        End If
                                
                                Next j
                                
                                        
                                        'Call Rept
                                        'Call 日更新
                                        
                                    'End If
                                End With
End With
End If
End With

With Application
    .Calculation = xlCalculationAutomatic
    .ScreenUpdating = True
End With

End Sub
Sub Rept()

Dim wb As Workbook, sh As Worksheet, i As Long, keikau As Variant, j As Long, keikau_val As Variant, writeRow As Long
Dim total_time As Long, StartDate As Date, EndDate As Date, waru As Double, addTime As Date
Dim wr_row As Long, s_time As Long, jisseki As Variant, jisseki2 As Variant, jisseki3 As Variant

Dim main_row As Long, jisseki1 As Variant, jugflg As Long

Set wb = ThisWorkbook
Set sh = wb.Sheets(shname_kaihatu)


With sh
i = .Cells(Rows.Count, 2).End(xlUp).Row
Do While i > 11
jugflg = 0
main_row = i
If .Cells(i, "T").Value <> "" Then

keikau = Split(.Cells(i, "T").Value, "/")
jisseki = Split(.Cells(i, "U").Value, ",")
'wr_row = i + 2
StartDate = .Cells(i, "J").Value
EndDate = .Cells(i, "K").Value
total_time = DateDiff("s", StartDate, EndDate)
For j = LBound(keikau) To UBound(keikau)
  
    Range(.Rows(10), .Rows(11)).Copy
    'writeRow = .Cells(Rows.Count, "P").End(xlUp).Row + 1
    main_row = main_row + 2
    Range(.Rows(main_row), .Rows(main_row + 1)).Insert
    Application.CutCopyMode = False
        keikau_val = Split(keikau(j), "-")
        .Cells(main_row, "I").Value = keikau_val(0)
        .Cells(main_row, "H").Value = keikau_val(1)
        waru = "0." & keikau_val(2)
        s_time = total_time * waru
        EndDate = DateAdd("s", s_time, StartDate)
        .Cells(main_row, "J").Value = StartDate
        .Cells(main_row, "K").Value = EndDate
        .Cells(main_row, "V").Value = StartDate
        .Cells(main_row, "W").Value = EndDate
        
        If StartDate <= Now Then
            .Cells(main_row, "L").Value = (DateDiff("s", StartDate, Now) / DateDiff("s", StartDate, EndDate)) * 100
            If .Cells(main_row, "L").Value > 100 Then
                .Cells(main_row, "L").Font.ColorIndex = 3
            End If
        End If
        .Cells(main_row, "M").Value = DateDiff("h", Now, EndDate)
        StartDate = EndDate
        
        
        If InStr(.Cells(i, "U").Value, ",") > 0 And jugflg = 0 Then
            If jisseki(j) <> "" Then
                jisseki1 = Split(jisseki(j), "&")
                If jisseki1(0) <> "" Then
                    jisseki2 = Split(jisseki1(0), "-")
                    .Cells(main_row, "X").Value = jisseki2(0)
                    .Cells(main_row, "N").Value = jisseki2(0)
                        If jisseki1(1) <> "" Then
                            jisseki3 = Split(jisseki1(1), "-")
                            .Cells(main_row, "O").Value = jisseki3(0)
                            .Cells(main_row, "Y").Value = jisseki3(0)
                            '''背景色をへんこうする
                                .Range(.Cells(main_row, "B"), .Cells(main_row + 1, "O")).Interior.ColorIndex = 15
                                .Cells(main_row, "L").Value = ""
                                .Cells(main_row, "M").Value = ""
                        End If
                End If
            Else
                jugflg = 1
            End If
        End If
        
        
        
Next j


End If

    i = i - 2
Loop

End With

End Sub
Sub 日更新()
Dim mb As Workbook, ms As Worksheet, st_1 As Long, st_2 As Date, st_3 As Date, key_41 As Date
Dim range_1 As Range, keyword As Variant, smal_d As Date, max_d As Date
Dim BeginX As Single, BeginY As Single, EndX As Single, EndY As Single, keywordt As Variant
Dim times_key As Variant


Set mb = ThisWorkbook
Set ms = mb.Sheets(shname_kaihatu)

With ms

Dim datsd As Date
Dim dated As Date
Dim datct As Date

Dim ingrw As Long
Dim inggs As Long
Dim ingge As Long, kiji As Date

datsd = Application.WorksheetFunction.Min(.Range("J:K"))
dated = Application.WorksheetFunction.Max(.Range("J:K"))

If Application.WorksheetFunction.Min(.Range("N:O")) < datsd Then
    datsd = Application.WorksheetFunction.Min(.Range("N:O"))
End If

If Application.WorksheetFunction.Max(.Range("N:O")) > dated Then
    dated = Application.WorksheetFunction.Max(.Range("N:O"))
End If

If dated < Now Then
    dated = Now
End If



i = 27
For datct = datsd To dated
.Cells(9, i).Value = datct
.Cells(9, i).NumberFormatLocal = "mm/dd"
i = i + 1
Next
.Range(.Columns(27), .Columns(i - 1)).ColumnWidth = 4

For ii = 10 To .UsedRange.Rows(.UsedRange.Rows.Count).Row Step 2
                    If .Cells(ii, "J").Value <> "" And .Cells(ii, "K").Value <> "" Then
                        If IsDate(.Cells(ii, "J").Value) = True And IsDate(.Cells(ii, "K").Value) = True And .Cells(ii, "K").Value >= .Cells(ii, "J").Value Then
                            kk = 0
                            
                                        For h = 1 To 2
                                        
                                        kiji = Format(.Cells(ii, 9 + h).Value, "mm/dd")
                                        
                                        Set obj = .Range(.Cells(9, 27), .Cells(9, .Cells(9, Columns.Count).End(xlToLeft).Column))
                                        Set obj_1 = obj.Find(Format(kiji, "mm/dd"), LookAt:=xlWhole, LookIn:=xlValues)
                                         If obj_1 Is Nothing Then
                                         kk = 1
                                         Else
                                        
                                             If h = 1 Then
                                                sta = obj_1.Column
                                             Else
                                                endi = obj_1.Column
                                             End If
                                         End If
                                        Next h
                           
                           
                           If kk = 0 Then
                           
                                            BeginX = .Cells(ii, sta).Left '- .Range("AS1").Width
                                            BeginY = .Cells(ii, sta).Top + .Cells(ii, 1).Height / 2
                                            
                                            EndX = .Cells(ii, endi).Left + .Range("AA1").Width
                                            EndY = .Cells(ii, endi).Top + .Cells(ii, 1).Height / 2
                                        
                                            
                                            
                                        ''''''''''''''''''''''''''''''''''''''''''''''''''''直線を引く
                                                With .Shapes.AddConnector(msoConnectorStraight, BeginX, BeginY, EndX, EndY).Line
                                                    .Style = msoLineSingle
                                                    .Weight = 5
                                                End With
                           
                           End If
    
                        End If
                    End If
                    '''''''実績を記述していこう
                    times_key = ""
                        If .Cells(ii, "N").Value <> "" Then
                                        
                                        If .Cells(ii, "O").Value = "" Then
                                            times_key = Now
                                        ElseIf IsDate(.Cells(ii, "O").Value) = True And .Cells(ii, "O").Value >= .Cells(ii, "N").Value Then
                                        Else
                                            GoTo 999
                                        End If
                                        
                                        
                        If IsDate(.Cells(ii, "N").Value) = True Then
                            kk = 0
                            
                                        For h = 1 To 2
                                        If h = 1 Then
                                            kiji = Format(.Cells(ii, 13 + h).Value, "yyyy/m/d")
                                        Else
                                            If times_key = "" Then
                                            kiji = Format(.Cells(ii, 13 + h).Value, "yyyy/m/d")
                                            Else
                                            kiji = Format(times_key, "yyyy/m/d")
                                            
                                            End If
                                        End If
                                        Set obj = .Range(.Cells(9, 27), .Cells(9, .Cells(9, Columns.Count).End(xlToLeft).Column))
                                        Set obj_1 = obj.Find(Format(kiji, "mm/dd"), LookAt:=xlWhole, LookIn:=xlValues)
                                        
                                         If obj_1 Is Nothing Then
                                         kk = 1
                                         Else
                                        
                                             If h = 1 Then
                                                sta = obj_1.Column
                                             Else
                                                endi = obj_1.Column
                                             End If
                                         End If
                                        Next h
                           
                           
                           If kk = 0 Then
                           
                                            BeginX = .Cells(ii + 1, sta).Left '- .Range("AS1").Width
                                            BeginY = .Cells(ii + 1, sta).Top + .Cells(ii, 1).Height / 2
                                            
                                            EndX = .Cells(ii + 1, endi).Left + .Range("AA1").Width
                                            EndY = .Cells(ii + 1, endi).Top + .Cells(ii, 1).Height / 2
                                        
                                            
                                        ''''''''''''''''''''''''''''''''''''''''''''''''''''直線を引く
                                                With .Shapes.AddConnector(msoConnectorStraight, BeginX, BeginY, EndX, EndY).Line
                                                    .Style = msoLineSingle
                                                    .Weight = 5
                                                    .ForeColor.SchemeColor = 2
                                                End With
999
                           End If
    
                        End If
                    End If
Next ii
                       
        .Range(.Cells(9, 27), .Cells(.Cells(Rows.Count, "P").End(xlUp).Row, .Cells(9, Columns.Count).End(xlToLeft).Column)).Borders.LineStyle = xlContinuous
 
End With

End Sub


  </code>
</pre>
  
</body>
</html>
