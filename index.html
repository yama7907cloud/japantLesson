<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>upload</title>
</head>
<body>
  <h1>名前で保存する</h1>
  <p>d6 リソースシートb3 完了以外を表示</p>
  <p>新しい情報です</p>
<pre>
  <code>
<%@ Language=VBScript %>
<!--#include file="config.inc" -->
<% 


Response.CodePage = 932  
Response.Charset = "Shift_JIS"

'グローバル変数定義
Dim hen1, hen2, hen3, hen4, openflg
Dim errMsg, pageSize, page, totalPages, suPage
Dim connStr
Dim action
Dim selectedItems, k, id, gk, parts, updateSql, rows, key
Dim conn, rs, sql, rs_hantr, sql_s, s_count, hyoji_count
Dim devcon, upvalues, bikou_value
Dim editData, records, item, keys, bikou_values, delData, derecords, deleteSql
Dim insertData, newRecords, gk_val, bikou_val, sqlInsert, insert_empno


action = Request("action")
editData = Request.Form("edit_data")
delData  = Request.Form("delete_data")
insertData = Request.Form("insert_data")

errMsg = ""
openflg = 0
suPage = 1
pageSize = 10 ' 1ページあたりの件数

If Request.ServerVariables("REQUEST_METHOD") = "POST" Then
    openflg = Request.Form("openflg")
    suPage = Request.Form("supage")
    hen1 = Request.Form("empno")
    hen3 = Request.Form("empname")

    If hen3 = "" Then
        errMsg = "従業員は必須です。"
    Else

If editData <> "" or delData <> "" or insertData <> "" Then
'updateの処理
    records = Split(editData, "###")
        For Each item In records
            keys = Split(item, "_")
            If UBound(keys) = 1 Then
                bikou_values = Replace(keys(1), "'", "''") ' SQLインジェクション対策
                    updateSql = "UPDATE hantr SET bikou = '" & bikou_values & "' WHERE id = " & keys(0)
                    Set devcon = Server.CreateObject("ADODB.Connection")
                    devcon.Open connStr
                    devcon.Execute updateSql
                    devcon.Close
                    Set devcon = Nothing
            End If
        Next
'deleteの処理
    derecords = Split(delData, "###")
        For Each item In derecords
            keys = Split(item, "_")
            If UBound(keys) = 1 Then
                deleteSql = "DELETE FROM hantr WHERE id = " & keys(0)
                Set devcon = Server.CreateObject("ADODB.Connection")
                devcon.Open connStr
                devcon.Execute deleteSql
                devcon.Close
                Set devcon = Nothing
            End If
        Next
'insertの処理
    newRecords = Split(insertData, "###")
    For Each item In newRecords
        keys = Split(item, "_")
        If UBound(keys) = 2 Then
            insert_empno = Replace(keys(0), "'", "''")
            gk_val = Replace(keys(1), "'", "''")
            bikou_val = Replace(keys(2), "'", "''")
            sqlInsert = "INSERT INTO hantr (gk, bikou, emp_no) VALUES ('" & gk_val & "', '" & bikou_val & "', " & insert_empno & ")"
            Set devcon = Server.CreateObject("ADODB.Connection")
            devcon.Open connStr
            devcon.Execute sqlInsert
            devcon.Close
            Set devcon = Nothing
        End If
    Next
End If
        
    End If
End If



    
    Set conn = Server.CreateObject("ADODB.Connection")
    conn.Open connStr

    sql = "SELECT * FROM kykms"
    Set rs = conn.Execute(sql)

If Not(openflg = 0) And Not(hen3 = "") Then
sql_s = ""
    page  = 0
    sql_s = "SELECT * FROM hantr where emp_no = " & hen1

    Set rs_hantr = Server.CreateObject("ADODB.Recordset")
    rs_hantr.CursorLocation = 3 
    rs_hantr.Open sql_s, conn, 3, 1 
    s_count = rs_hantr.RecordCount
    If s_count > 0 Then
    totalPages = Int((s_count + pageSize - 1) / pageSize)
        page = CInt(suPage)
        If page < 1 Then page = 1
        If page > totalPages Then page = totalPages
        Dim startRecord
        startRecord = (page - 1) * pageSize + 1
        If s_count > 0 Then
            rs_hantr.MoveFirst
            rs_hantr.Move startRecord - 1
        End If
    End If
End If

Sub finalexe()
    rs.Close
    If Not(openflg = 0) And Not(hen3 = "") Then
        rs_hantr.Close
    End If
    Set rs = Nothing
    Set rs_hantr = Nothing
    conn.Close
    Set conn = Nothing
End Sub

Sub SerchPager()
Dim s_cla, e_cla
s_cla = ""
e_cla = ""
If s_count <= 0 Or totalPages = 1 Then
    s_cla = "not"
    e_cla = "not"
Else
    If page <= 1 Then
        s_cla = "not"
    ElseIf page >= totalPages Then
        e_cla = "not"
    End If

End If

                 %>
                <button type="submit" name="supage" value="<%=page-1%>" class="<%=s_cla%>">前へ</button>
                <button type="submit" name="supage" value="<%=page+1%>" class="<%=e_cla%>">次へ</button>
                <% 
                hyoji_count = 0
                If s_count > 0 Then 
                    hyoji_count = s_count
                %>
                    <span>件数:<%=hyoji_count%> 件 ページ <%=page%> / <%=totalPages%>）</span>
                <%
                Else
                %>
                    <span>件数: <%=hyoji_count%> 件</span>
                <%
                End If
                %>
                <%
End Sub
%>

<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link rel="stylesheet" href="style.css">
<title>これはテストです</title>
</head>
<body>

        <h1>ここから下はサーバーからの情報です編集してみました</h1>
                <form  method="post">
            <div class="div_f_container">
                <input type="hidden" name="openflg" value=1>
                <input type="hidden" name="edit_data" id="edit_data">
                <input type="hidden" name="delete_data" id="delete_data">
                <input type="hidden" name="insert_data" id="insert_data">
                従業員番号: <input type="text" id="empno" name="empno" onblur="getName()" value="<%=Server.HTMLEncode(hen1)%>">
                氏名: <input type="text" id="empname" readonly name="empname" value="<%=Server.HTMLEncode(hen3)%>"><br>
                検索:<input type="submit" name="action" value="検索" style="width:150px; height:30px;"><br>   
                登録:<button type="submit" name="action" value="登録" style="width:150px; height:30px;" onclick="update_value()">登録</button>
                新規行追加:<button type="button" name="insert" value="新規" id="insert" style="width:150px; height:30px;">新規行追加</button><br>
            </div>
            <div class="pager"> 
                <% Call SerchPager() %>
            </div>
            
<% 
                If s_count > 0 Then
                %>
                <table border="1">
                    <colgroup>
                    <col style="width: 50px;">
                    <col style="width: 200px;">
                    <col style="width: 300px;">
                    <col style="width: 400px;">
                    <col style="width: 50px;">
                    </colgroup>
                <tr><th>編集</th><th>ID</th><th>gk</th><th>bikou</th><th>削除</th></tr>
                <%
                    Dim i
                    i = 0
                    While Not rs_hantr.EOF And i < pageSize
                %>
                    <tr class="" id="tr_<%=i%>">
                        <td><input type="checkbox" name="edit_id" data-num="<%=i%>" id="edit_<%=i%>" value="<%=i%>" onclick="toggleEdit(this)"></td>
                        <td>
                            <input type="text" class="readonly-style"
                            name="id" 
                            value="<%=rs_hantr("id")%>"
                            readonly>
                        </td>
                        <td>
                            <input type="text" class="readonly-style"
                            name="gk" 
                            value="<%=rs_hantr("gk")%>"
                            readonly>
                        </td>
                        <td>
                            <input type="text" class="readonly-style"
                            name="bikou_<%=rs_hantr("id") & "_" & rs_hantr("gk")%>"
                            data-bg="<%=i%>" 
                            id="bikou_<%=i%>"
                            value="<%=Server.HTMLEncode(rs_hantr("bikou"))%>"
                            data-idn="<%=Server.HTMLEncode(rs_hantr("id"))%>"
                            readonly>
                        </td>
                        <td><input type="checkbox" name="delete_id" data-num="<%=i%>"  class="accent_c" id="delete_<%=i%>" name="delete_id"  value="<%=i%>" onclick="toggleEdit(this)"></td>
                    </tr>
                <%
                        rs_hantr.MoveNext
                        i = i + 1
                    Wend
                %>
                    </table>
                </form>
                <%
                End If

                    
                Call finalexe()
                If Not(errMsg = "") Then
                %>
                <p><%=errMsg%></p>
                <%
                End If
        %>
        <script src="default.js"></script>
</body>
</html>
'use strict';

    function getName() {
        var empNo = document.getElementById("empno").value;
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function() {
            if (xhr.readyState == 4 && xhr.status == 200) {
                document.getElementById("empname").value = xhr.responseText;
            }
        };
        xhr.open("GET", "get_name.asp?empno=" + encodeURIComponent(empNo), true);
        xhr.send();
    }
    
    function toggleEdit(obj){  
        var key_num = obj.dataset.num;
        var input = document.getElementById("bikou_" + key_num);
        var edits = document.getElementById("edit_" + key_num);
        var dels = document.getElementById("delete_" + key_num);
        var tr = document.getElementById("tr_" + key_num);
        if (obj.checked) {
            input.removeAttribute("readonly");
            input.classList.remove("readonly-style");
            tr.classList.add("bg_color");
        } else {
            if (!dels.checked){
                if(!edits.checked){
                    input.setAttribute("readonly", true);
                    input.classList.add("readonly-style");
                    tr.classList.remove("bg_color");
                }
    
            }
        }
    }
    
    function update_value(){
        const checkedValues = Array.from(document.querySelectorAll('input[name="edit_id"]:checked'))
        .map(el => el.value);
        const checkedDelValues = Array.from(document.querySelectorAll('input[name="delete_id"]:checked'))
        .map(el => el.value);
        const checkedNewValues = Array.from(document.querySelectorAll('input[name="id"]'))
        .filter(input => input.value.startsWith("new"));


        let edit_result = [];
        let del_result=[];
        let insert_result = [];

        checkedValues.forEach(value => {
            let input = document.getElementById("bikou_" + value);
            let ker = input.dataset.idn;
            if (input) {
                edit_result.push(ker + "_" + input.value);
            }
        });
        checkedDelValues.forEach(value => {
            let input = document.getElementById("bikou_" + value);
            let ker = input.dataset.idn;
            if (input) {
                del_result.push(ker + "_" + input.value);
            }
        });
        checkedNewValues.forEach(idInput => {
            const row = idInput.closest("tr");
            const id = idInput.value;
            const gkInput = row.querySelector('input[name="gk"]');
            const bikouInput = row.querySelector(`input[name="bikou_${id}"]`);
            const empno = document.getElementById("empno");
            const empname = document.getElementById("empname");

            const gk = gkInput ? gkInput.value : "";
            const bikou = bikouInput ? bikouInput.value : "";
            if(isNaN(gk)){
                alert("数字を入力してね");
                return;
            }

            if (gk !== "" && bikou !== "" && empno.value !== "" && empname.value !== "") {
                insert_result.push(`${empno.value}_${gk}_${bikou}`);
            }
        });

        if(edit_result.length > 0 || del_result.length > 0 || insert_result.length > 0){
            let result = confirm("本当にデータを更新しますか");
            if(result){
                if(edit_result.length > 0){
                    document.getElementById("edit_data").value = edit_result.join("###");
                }
                if(del_result.length > 0){
                    document.getElementById("delete_data").value = del_result.join("###");
                }
                if(insert_result.length > 0){
                    document.getElementById("insert_data").value = insert_result.join("###");
                }
            }
        }
    }
    
    
    function new_recorde_value(){
        event.preventDefault();
        const table = document.querySelector("table");
        if (!table) return;
        
        const rowCount = table.rows.length;
        const newRow = table.insertRow(1); 
        
        // ID, gkの自動仮番号（本来はサーバー採番ですが仮で）
        const newId = "new";

        // 編集チェックボックス
        const editCell = newRow.insertCell(0);
        editCell.innerHTML = `<input type="checkbox" onclick="toggleEdit(this)" checked disabled>`;
        
        // IDセル（readonly）
        const idCell = newRow.insertCell(1);
        idCell.innerHTML = `<input type="text" class="readonly-style" name="id" value="${newId}" readonly>`;
        
        // GKセル（readonly）
        const gkCell = newRow.insertCell(2);
        gkCell.innerHTML = `<input type="text" class="" name="gk" value="" inputmode="numeric" style="ime-mode:disabled;">`;
        
        // 備考入力欄（編集可能）
        const bikouCell = newRow.insertCell(3);
        bikouCell.innerHTML = `<input type="text" name="bikou_${newId}" id="bikou_${newId}" value="">`;
        
        // 削除チェック
        const delCell = newRow.insertCell(4);
        delCell.innerHTML = `<input type="checkbox" disabled>`;
    }

document.addEventListener("DOMContentLoaded", function() {
  document.getElementById("insert").addEventListener("click", new_recorde_value);
});





  </code>
</pre>
  
</body>
</html>
